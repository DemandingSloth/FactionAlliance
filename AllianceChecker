// ==UserScript==
// @name         Torn: Iron Dome Checker (Desktop, Hardcoded)
// @namespace    WetNightmare - GargoyleGoliath [3684397]
// @version      1.0.1
// @description  Desktop userscript: adds a 375x140 Iron Dome banner below profile action buttons when the profile's faction is in a hardcoded list.
// @match        https://www.torn.com/profiles.php*
// @match        https://www.torn.com/*/profiles.php*
// @icon         https://www.torn.com/favicon.ico
// @run-at       document-idle
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  // ---------------- Hardcoded Iron Dome factions ----------------
  const IRON_DOME_FACTIONS = [
    "Combat Ready HQ",
    "CR-ACK",
    "CRashpad",
    "Cosa-Nostra",
    "Desert Phoenix",
    "Desert Falcon",
    "Halos Pulse",
    "Rockstars",
    "Angels of Deception",
    "Angels of Domination",
    "Forbidden Realm",
    "MYTHIC MAYHEM",
    "Valors Edge",
    "Strikeforce",
    "2nd Chance",
    "Academy of Strippers",
    "Echoes of Eden",
    "The Hollowed Order",
    "United Earth Empire"
  ];
  const FACTION_SET = new Set(IRON_DOME_FACTIONS.map(s => s.trim().toLowerCase()));

  // ---------------- Config ----------------
  const CONFIG = {
    bannerUrl: 'https://i.postimg.cc/DwzZ2yx7/lv-0-202511100135130ezgif-com-resize.gif?raw=true',
    bannerId:  'iron-dome-banner',
    maxWaitMs: 12000,   // wait up to 12s for DOM anchors
    evalDebounceMs: 200 // debounce for SPA updates
  };

  // ---------------- Helpers ----------------
  const norm = s => (s || '').trim().toLowerCase();
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  function isProfilePage() {
    // Handles both /profiles.php?XID=... and internationalized paths like /some-locale/profiles.php?...
    return /\/profiles\.php$/i.test(location.pathname);
  }

  function extractFactionName() {
    // Desktop Torn structure usually includes span[title*=" of "] with an <a> to factions.php
    const span = Array.from(document.querySelectorAll('span[title*=" of "]'))
      .find(el => el.querySelector('a[href*="/factions.php"]'));
    if (!span) return null;
    const link = span.querySelector('a[href*="/factions.php"]');
    return link ? link.textContent.trim() : null;
  }

  function findButtonsList() {
    // Desktop also uses .buttons-list for the block containing profile action buttons
    return document.querySelector('.buttons-list');
  }

  function removeExisting() {
    document.getElementById(CONFIG.bannerId)?.remove();
  }

  function buildBanner() {
    const img = document.createElement('img');
    img.id = CONFIG.bannerId;
    img.src = CONFIG.bannerUrl;
    img.alt = 'Iron Dome Alliance';
    img.loading = 'lazy';
    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';
    // 375x140 banner
    img.style.width = '375px';
    img.style.height = '140px';
    img.style.display = 'block';
    img.style.margin = '10px auto 6px auto';
    img.style.border = '1px solid rgba(255,255,255,0.12)';
    img.style.borderRadius = '8px';
    return img;
  }

  function insertBanner() {
    const buttonsList = findButtonsList();
    const img = buildBanner();
    if (buttonsList) {
      buttonsList.insertAdjacentElement('afterend', img);
    } else {
      // Fallback: still show if the action bar isn't found (rare on desktop, but helpful on slow loads)
      (document.querySelector('#mainContainer, main, #content, body') || document.body).appendChild(img);
    }
  }

  async function waitForProfileDom() {
    const start = Date.now();
    while (Date.now() - start < CONFIG.maxWaitMs) {
      const hasButtons = !!findButtonsList();
      const hasFaction = !!document.querySelector('span[title*=" of "] a[href*="/factions.php"]');
      if (hasButtons && hasFaction) return true;
      await sleep(150);
    }
    // Even if we time out, we can still try—just less reliably
    return false;
  }

  // ---------------- Main (debounced, SPA-safe) ----------------
  let evaluating = false;
  let timer = null;

  function scheduleEvaluate(reason = 'mutation') {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => void evaluate(reason), CONFIG.evalDebounceMs);
  }

  async function evaluate(reason = 'init') {
    if (!isProfilePage()) return;
    if (evaluating) return;
    evaluating = true;

    try {
      await waitForProfileDom();

      const faction = extractFactionName();
      if (!faction) return;

      const isMember = FACTION_SET.has(norm(faction));
      removeExisting();
      if (isMember) insertBanner();
    } finally {
      evaluating = false;
    }
  }

  function hookHistoryNavigation() {
    // Some Torn navigations use pushState/replaceState; re-check on SPA route changes.
    const push = history.pushState;
    const replace = history.replaceState;

    history.pushState = function () {
      const ret = push.apply(this, arguments);
      window.dispatchEvent(new Event('locationchange'));
      return ret;
    };
    history.replaceState = function () {
      const ret = replace.apply(this, arguments);
      window.dispatchEvent(new Event('locationchange'));
      return ret;
    };
    window.addEventListener('popstate', () => window.dispatchEvent(new Event('locationchange')));
  }

  // ---------------- Boot ----------------
  function boot() {
    hookHistoryNavigation();

    // Initial pass (after Torn renders initial content)
    evaluate('init');

    // Keep up with DOM churn from Torn’s SPA
    const obs = new MutationObserver(() => scheduleEvaluate('mutation'));
    obs.observe(document.documentElement, { childList: true, subtree: true });

    // React to SPA URL changes
    window.addEventListener('locationchange', () => scheduleEvaluate('url-change'));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
